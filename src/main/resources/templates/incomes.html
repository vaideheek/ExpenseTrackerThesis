<!DOCTYPE html>
<html lang="en">
<head>
  <title>Income Management</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

</head>
<body>
<h1>Income Management</h1>

<!-- Form to Add Income Source -->
<form id="incomeForm">
  <label for="sourceName">Income Source:</label>
  <input type="text" id="sourceName" name="sourceName" required>

  <label for="amount">Amount:</label>
  <input type="number" id="amount" name="amount" required>

  <label for="incomeDate">Income Date:</label>
  <input type="date" id="incomeDate" name="incomeDate" required>

  <button type="submit">Add Income</button>
</form>

<!-- Income History Table -->
<table id="incomeTable">
  <thead>
  <tr>
    <th>Income Source</th>
    <th>Amount</th>
    <th>Income Date</th>
    <th>Actions</th>
  </tr>
  </thead>
  <tbody>
  <!-- Income records will be displayed here -->
  </tbody>
</table>

<!-- Chart for Income Analysis -->
<div id="incomeAnalysisChartContainer">
  <canvas id="incomeChart" width="400" height="200"></canvas>
</div>


<!-- Edit Modal -->
<div class="modal" tabindex="-1" role="dialog" id="editModal">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Edit Income Record</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <!-- Form to edit income record -->
        <form id="editIncomeForm">
          <label for="editSourceName">Income Source:</label>
          <input type="text" id="editSourceName" name="editSourceName" required>

          <label for="editAmount">Amount:</label>
          <input type="number" id="editAmount" name="editAmount" required>

          <label for="editIncomeDate">Income Date:</label>
          <input type="date" id="editIncomeDate" name="editIncomeDate" required>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" onclick="updateIncome()">Save changes</button>
      </div>
    </div>
  </div>
</div>



<!-- JavaScript to handle interactions and AJAX calls -->
<script>
  function updateIncome(id) {
    // Capture updated data from the modal fields
    const updatedSourceName = document.getElementById("editSourceName").value;
    const updatedAmount = parseFloat(document.getElementById("editAmount").value);
    const updatedIncomeDate = document.getElementById("editIncomeDate").value;

    // Create a JSON object with the updated data
    const updatedIncome = {
      sourceName: updatedSourceName,
      amount: updatedAmount,
      incomeDate: updatedIncomeDate,
    };

    // Send an AJAX PUT request to update the income record
    fetch(`http://localhost:8080/incomes/update/${id}`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(updatedIncome),
    })
            .then(response => response.json())
            .then(() => {
              // Close the edit modal
              $('#editModal').modal('hide');

              // Refresh the income history table
              displayIncomeHistory();
            })
            .catch(error => {
              console.error('Error updating income data: ', error);
            });
  }


  // Function to fetch and display income data in the table
  function displayIncomeHistory() {
    // Extract data from the HTML table
    const table = document.getElementById("incomeTable");
    const rows = table.getElementsByTagName("tr");
    const labels = [];
    const data = [];

    for (let i = 1; i < rows.length; i++) {
      const cells = rows[i].getElementsByTagName("td");
      labels.push(cells[0].textContent);
      data.push(parseFloat(cells[1].textContent));

      // Add Edit and Delete buttons with dynamic data attributes
      const actionsCell = rows[i].insertCell(3);
      const editButton = document.createElement('button');
      editButton.textContent = 'Edit';
      editButton.dataset.id = i.toString(); // Set the dataset ID
      editButton.addEventListener('click', editIncome);

      const deleteButton = document.createElement('button');
      deleteButton.textContent = 'Delete';
      deleteButton.dataset.id = i.toString(); // Set the dataset ID
      deleteButton.addEventListener('click', confirmDeleteIncome);

      actionsCell.appendChild(editButton);
      actionsCell.appendChild(deleteButton);
    }

    // Find the canvas element in the DOM
    const canvas = document.getElementById("incomeChart");

    // Create the chart using the extracted data
    new Chart(canvas, {
      type: "bar",
      data: {
        labels: labels,
        datasets: [
          {
            label: "Income Analysis",
            data: data,
            backgroundColor: "rgba(75, 192, 192, 0.2)",
            borderColor: "rgba(75, 192, 192, 1)",
            borderWidth: 1,
          },
        ],
      },
      options: {
        scales: {
          y: {
            beginAtZero: true,
          },
        },
      },
    });
  }

  // Function to open the edit modal for a specific income record
  function editIncome(event) {
    const id = event.target.dataset.id; // Get the dataset ID
    // Fetch the income record based on the given ID from the backend
    fetch(`http://localhost:8080/incomes/${id}`)
            .then(response => response.json())
            .then(data => {
              // Populate the modal fields with the income data
              document.getElementById("editSourceName").value = data.sourceName;
              document.getElementById("editAmount").value = data.amount;
              document.getElementById("editIncomeDate").value = data.incomeDate;

              // Show the edit modal
              $('#editModal').modal('show');

              // Pass the id to the updateIncome function
              document.getElementById("editIncomeForm").onsubmit = function (e) {
                e.preventDefault();
                updateIncome(id);
              };
            })
            .catch(error => {
              console.error('Error fetching income data for edit: ', error);
            });
  }






  // Function to open a confirmation dialog for deleting income
  function confirmDeleteIncome(event) {
    const id = event.target.dataset.id; // Get the dataset ID
    if (confirm('Are you sure you want to delete this income record?')) {
      deleteIncome(id);
    }
  }

  // Function to delete an income record
  function deleteIncome(id) {
    // Send an AJAX DELETE request to delete the income record
    fetch(`http://localhost:8080/incomes/delete/${id}`, {
      method: 'DELETE',
    })
            .then(() => {
              // Refresh the income history table
              displayIncomeHistory();
            })
            .catch(error => {
              console.error('Error deleting income data: ', error);
            });
  }

  document.addEventListener("DOMContentLoaded", function () {


    // Function to add a new income source
    function addIncomeSource() {
      // Capture form data and make an AJAX request to add the income source
      const sourceName = document.getElementById("sourceName").value;
      const amount = parseFloat(document.getElementById("amount").value);
      const incomeDate = document.getElementById("incomeDate").value;

      fetch('http://localhost:8080/incomes/add', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ sourceName, amount, incomeDate }),
      })
              .then(response => response.json())
              .then(()=> {
                // After adding, call displayIncomeHistory() to refresh the table
                displayIncomeHistory();
              })
              .catch(error => {
                console.error('Error adding income source: ', error);
              });
    }





    // Handle form submission for adding income
    document.getElementById("incomeForm").addEventListener("submit", function (e) {
      e.preventDefault(); // Prevent the default form submission
      addIncomeSource();
    });

    // Display income history on page load
    displayIncomeHistory();
  });
</script>
</body>
</html>
